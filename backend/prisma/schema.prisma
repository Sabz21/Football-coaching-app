// Football Coaching Platform - Database Schema
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

enum Role {
  COACH
  PARENT
  PLAYER
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  avatar        String?
  role          Role
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations based on role
  coachProfile  Coach?
  parentProfile Parent?
  playerProfile Player?

  @@map("users")
}

model Coach {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  bio             String?
  specializations String[]
  experience      Int?
  certifications  String[]
  hourlyRate      Decimal? @db.Decimal(10, 2)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  availabilitySlots AvailabilitySlot[]
  sessions          Session[]
  sessionReports    SessionReport[]
  players           Player[]

  @@map("coaches")
}

model Parent {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  address   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  children  Player[]
  bookings  Booking[]

  @@map("parents")
}

model Player {
  id            String    @id @default(cuid())
  userId        String?   @unique
  user          User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  firstName     String
  lastName      String
  dateOfBirth   DateTime
  avatar        String?
  position      String?
  preferredFoot String?
  height        Int?
  weight        Int?
  notes         String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  parentId            String?
  parent              Parent?             @relation(fields: [parentId], references: [id], onDelete: SetNull)
  coachId             String?
  coach               Coach?              @relation(fields: [coachId], references: [id], onDelete: SetNull)
  performanceMetrics  PerformanceMetric[]
  sessionReports      SessionReport[]
  bookings            Booking[]
  achievements        Achievement[]

  @@map("players")
}

// ============================================
// SCHEDULING & SESSIONS
// ============================================

model AvailabilitySlot {
  id          String   @id @default(cuid())
  coachId     String
  coach       Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)
  dayOfWeek   Int
  startTime   String
  endTime     String
  location    String
  isRecurring Boolean  @default(true)
  specificDate DateTime?
  maxPlayers  Int      @default(1)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sessions    Session[]

  @@map("availability_slots")
}

enum SessionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum SessionType {
  INDIVIDUAL
  GROUP
  ASSESSMENT
  TRIAL
}

model Session {
  id             String        @id @default(cuid())
  coachId        String
  coach          Coach         @relation(fields: [coachId], references: [id], onDelete: Cascade)
  slotId         String?
  slot           AvailabilitySlot? @relation(fields: [slotId], references: [id], onDelete: SetNull)
  date           DateTime
  startTime      String
  endTime        String
  location       String
  type           SessionType   @default(INDIVIDUAL)
  status         SessionStatus @default(SCHEDULED)
  maxParticipants Int          @default(1)
  notes          String?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  bookings       Booking[]
  sessionReports SessionReport[]

  @@map("sessions")
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

model Booking {
  id          String        @id @default(cuid())
  sessionId   String
  session     Session       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  playerId    String
  player      Player        @relation(fields: [playerId], references: [id], onDelete: Cascade)
  parentId    String
  parent      Parent        @relation(fields: [parentId], references: [id], onDelete: Cascade)
  status      BookingStatus @default(PENDING)
  notes       String?
  bookedAt    DateTime      @default(now())
  confirmedAt DateTime?
  cancelledAt DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([sessionId, playerId])
  @@map("bookings")
}

// ============================================
// PERFORMANCE TRACKING
// ============================================

enum MetricCategory {
  TECHNICAL
  PHYSICAL
  TACTICAL
  MENTAL
}

model PerformanceMetric {
  id          String         @id @default(cuid())
  playerId    String
  player      Player         @relation(fields: [playerId], references: [id], onDelete: Cascade)
  category    MetricCategory
  name        String
  value       Decimal        @db.Decimal(5, 2)
  unit        String?
  measuredAt  DateTime       @default(now())
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([playerId, category])
  @@index([playerId, measuredAt])
  @@map("performance_metrics")
}

model SessionReport {
  id              String   @id @default(cuid())
  sessionId       String
  session         Session  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  playerId        String
  player          Player   @relation(fields: [playerId], references: [id], onDelete: Cascade)
  coachId         String
  coach           Coach    @relation(fields: [coachId], references: [id], onDelete: Cascade)
  
  effortRating    Int      @default(5)
  focusRating     Int      @default(5)
  technicalRating Int      @default(5)
  
  highlights      String?
  improvements    String?
  coachNotes      String?
  playerFeedback  String?
  
  drillsCompleted String[]
  focusAreas      String[]
  
  attendance      Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([sessionId, playerId])
  @@map("session_reports")
}

// ============================================
// GAMIFICATION & ENGAGEMENT
// ============================================

enum AchievementType {
  MILESTONE
  SKILL
  ATTENDANCE
  IMPROVEMENT
  SPECIAL
}

model Achievement {
  id          String          @id @default(cuid())
  playerId    String
  player      Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)
  type        AchievementType
  name        String
  description String?
  icon        String?
  earnedAt    DateTime        @default(now())
  createdAt   DateTime        @default(now())

  @@map("achievements")
}

model MetricDefinition {
  id          String         @id @default(cuid())
  category    MetricCategory
  name        String
  description String?
  unit        String?
  minValue    Decimal        @default(0) @db.Decimal(5, 2)
  maxValue    Decimal        @default(100) @db.Decimal(5, 2)
  isDefault   Boolean        @default(false)
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([category, name])
  @@map("metric_definitions")
}
